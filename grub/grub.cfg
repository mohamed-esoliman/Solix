#
# GRUB Configuration for Solix Linux
# Part of the Solix custom Linux build
#
# This configuration provides automated and manual boot options
# for the Solix operating system.
#

# Timeout before default boot (3 seconds)
set timeout=3
set default=0

# Load video and graphics modules for better display
insmod vbe
insmod vga
insmod video_bochs
insmod video_cirrus
insmod gfxterm
insmod png
insmod jpeg

# Set graphics mode for better appearance
if loadfont /boot/grub/fonts/unicode.pf2 ; then
    set gfxmode=auto
    terminal_output gfxterm
fi

# Theme and appearance
set menu_color_normal=white/black
set menu_color_highlight=black/light-gray

# Solix banner
echo "Loading Solix Custom Linux System..."

# Main boot entry - Solix Linux
menuentry "Solix Linux (Default)" {
    echo "Loading Solix kernel..."
    
    # Load the kernel with appropriate parameters
    linux /boot/vmlinuz root=/dev/ram0 rw init=/etc/init.d/rcS \
          console=tty0 console=ttyS0,115200n8 \
          quiet splash loglevel=3 \
          panic=10 oops=panic
    
    echo "Loading initial ramdisk..."
    
    # Load the initramfs
    initrd /boot/initramfs.img
    
    echo "Starting Solix..."
}

# Verbose boot option
menuentry "Solix Linux (Verbose Boot)" {
    echo "Loading Solix kernel with verbose output..."
    
    # Load kernel with verbose logging
    linux /boot/vmlinuz root=/dev/ram0 rw init=/etc/init.d/rcS \
          console=tty0 console=ttyS0,115200n8 \
          debug loglevel=7 \
          panic=10 oops=panic \
          initcall_debug
    
    echo "Loading initial ramdisk..."
    
    # Load the initramfs
    initrd /boot/initramfs.img
    
    echo "Starting Solix with verbose logging..."
}

# Recovery mode
menuentry "Solix Linux (Recovery Mode)" {
    echo "Loading Solix kernel in recovery mode..."
    
    # Load kernel with recovery parameters
    linux /boot/vmlinuz root=/dev/ram0 rw init=/etc/init.d/rcS \
          console=tty0 console=ttyS0,115200n8 \
          single recovery \
          loglevel=4 \
          panic=10
    
    echo "Loading initial ramdisk..."
    
    # Load the initramfs
    initrd /boot/initramfs.img
    
    echo "Starting Solix in recovery mode..."
}

# Memory test (if memtest86+ is available)
if [ -f /boot/memtest86+.bin ]; then
    menuentry "Memory Test (Memtest86+)" {
        echo "Loading memory test..."
        linux16 /boot/memtest86+.bin
    }
fi

# GRUB command line
menuentry "GRUB Command Line" {
    echo "Entering GRUB command line..."
    echo "Type 'exit' to return to menu"
    insmod normal
    normal
}

# System information display
menuentry "System Information" {
    echo "==================================="
    echo "      Solix System Information     "
    echo "==================================="
    echo "OS: Solix Custom Linux"
    echo "Version: 1.0"
    echo "Kernel: Linux 6.6.8-solix"
    echo "Architecture: x86_64"
    echo "Build: Handcrafted from scratch"
    echo "==================================="
    echo ""
    echo "Hardware Information:"
    
    # Display basic hardware info if available
    if cpuid -1; then
        echo "CPU information available"
    fi
    
    if lsmem; then
        echo "Memory information available"
    fi
    
    echo ""
    echo "Press any key to return to menu..."
    read
}

# Shutdown option
menuentry "Shutdown" {
    echo "Shutting down system..."
    halt
}

# Reboot option
menuentry "Reboot" {
    echo "Rebooting system..."
    reboot
}

# Advanced options submenu
submenu "Advanced Options..." {
    
    menuentry "Boot with init=/bin/sh" {
        echo "Loading Solix kernel with emergency shell..."
        
        linux /boot/vmlinuz root=/dev/ram0 rw init=/bin/sh \
              console=tty0 console=ttyS0,115200n8 \
              debug loglevel=7
        
        initrd /boot/initramfs.img
        
        echo "Starting emergency shell..."
    }
    
    menuentry "Boot without initramfs" {
        echo "Loading Solix kernel without initramfs..."
        
        linux /boot/vmlinuz root=/dev/sda1 rw init=/etc/init.d/rcS \
              console=tty0 console=ttyS0,115200n8 \
              loglevel=4
        
        echo "Starting without initramfs..."
    }
    
    menuentry "Boot with different root" {
        echo "Loading Solix kernel with custom root..."
        
        linux /boot/vmlinuz root=/dev/sdb1 rw init=/etc/init.d/rcS \
              console=tty0 console=ttyS0,115200n8 \
              loglevel=4
        
        initrd /boot/initramfs.img
        
        echo "Starting with custom root filesystem..."
    }
    
    menuentry "Network boot test" {
        echo "Testing network boot capabilities..."
        
        linux /boot/vmlinuz root=/dev/ram0 rw init=/etc/init.d/rcS \
              console=tty0 console=ttyS0,115200n8 \
              ip=dhcp netconsole=6666@/eth0,9353@10.0.2.2/ \
              loglevel=4
        
        initrd /boot/initramfs.img
        
        echo "Starting with network configuration..."
    }
}

# Help information
submenu "Help & Information..." {
    
    menuentry "Boot Options Help" {
        echo "========================================="
        echo "           Solix Boot Options           "
        echo "========================================="
        echo ""
        echo "Default Boot:"
        echo "  - Normal Solix boot with quiet output"
        echo "  - Custom init system"
        echo "  - Solix shell interface"
        echo ""
        echo "Verbose Boot:"
        echo "  - Detailed kernel and init messages"
        echo "  - Useful for troubleshooting"
        echo ""
        echo "Recovery Mode:"
        echo "  - Minimal boot for system recovery"
        echo "  - Single user mode"
        echo "  - Basic shell access"
        echo ""
        echo "Kernel Parameters:"
        echo "  root=/dev/ram0  - Use ramdisk as root"
        echo "  init=/etc/init.d/rcS - Custom init script"
        echo "  console=tty0    - Console output"
        echo "  loglevel=N      - Kernel log level (0-7)"
        echo ""
        echo "Press any key to return..."
        read
    }
    
    menuentry "Keyboard Shortcuts" {
        echo "========================================="
        echo "          GRUB Keyboard Shortcuts       "
        echo "========================================="
        echo ""
        echo "Navigation:"
        echo "  ↑/↓ arrows    - Move between menu items"
        echo "  Enter         - Boot selected item"
        echo "  e             - Edit boot parameters"
        echo "  c             - Open GRUB command line"
        echo ""
        echo "Editing:"
        echo "  e             - Edit current entry"
        echo "  Ctrl+x/F10    - Boot with modifications"
        echo "  Esc           - Cancel editing"
        echo ""
        echo "Special:"
        echo "  Tab           - Command completion"
        echo "  Ctrl+Alt+Del  - Reboot"
        echo ""
        echo "Press any key to return..."
        read
    }
    
    menuentry "About Solix" {
        echo "========================================="
        echo "              About Solix               "
        echo "========================================="
        echo ""
        echo "Solix is a custom Linux distribution"
        echo "built entirely from scratch following"
        echo "Linux From Scratch (LFS) principles."
        echo ""
        echo "Components:"
        echo "  • Custom toolchain (binutils, GCC, glibc)"
        echo "  • Linux kernel 6.6.8 with minimal config"
        echo "  • Custom bash-based init system"
        echo "  • Custom shell written in C"
        echo "  • GRUB2 bootloader"
        echo ""
        echo "Purpose:"
        echo "  Demonstration of low-level"
        echo "  systems programming and OS development."
        echo ""
        echo "Author: Mohamed Soliman"
echo "License: MIT"
        echo ""
        echo "Press any key to return..."
        read
    }
} 